<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Dive: OneMindAI Error Recovery System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --dark: #2d3748;
            --light: #f8f9fa;
            --code-bg: #282c34;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 40px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
            display: grid;
            grid-template-columns: 300px 1fr;
        }
        
        /* Sidebar Navigation */
        .sidebar {
            background: #2d3748;
            color: white;
            padding: 20px;
            height: 100vh;
            position: sticky;
            top: 0;
            overflow-y: auto;
        }
        
        .sidebar h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .nav-item {
            display: block;
            padding: 12px 15px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .nav-item:hover, .nav-item.active {
            background: var(--primary);
            color: white;
            transform: translateX(5px);
        }
        
        .nav-item i { margin-right: 10px; }
        
        /* Main Content */
        .content {
            padding: 40px;
            background: white;
        }
        
        .section {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .section.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h1 { font-size: 2.5rem; color: var(--dark); margin-bottom: 10px; }
        h2 { font-size: 1.8rem; color: var(--primary); margin: 30px 0 20px; border-left: 5px solid var(--primary); padding-left: 15px; }
        h3 { font-size: 1.4rem; color: var(--secondary); margin: 20px 0 15px; }
        
        /* Code Blocks with File Info */
        .code-container {
            background: var(--code-bg);
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .file-header {
            background: #21252b;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #abb2bf;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .file-icon { color: #e06c75; }
        .line-info { color: #5c6370; font-size: 0.8rem; }
        
        pre { margin: 0; padding: 20px; overflow-x: auto; }
        code { font-family: 'Fira Code', monospace; font-size: 14px; }
        
        /* Visual Flow Diagrams */
        .flow-diagram {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            text-align: center;
            position: relative;
        }
        
        .flow-step {
            background: white;
            padding: 15px 25px;
            border-radius: 50px;
            border: 2px solid var(--primary);
            display: inline-block;
            margin: 10px;
            position: relative;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .flow-step:hover { transform: scale(1.05); }
        
        .arrow {
            font-size: 24px;
            color: var(--primary);
            display: inline-block;
            margin: 0 10px;
            vertical-align: middle;
        }
        
        /* Explainer Boxes */
        .explainer {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        
        .explainer-card {
            flex: 1;
            background: #fff;
            border-left: 4px solid var(--info);
            padding: 20px;
            border-radius: 0 8px 8px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .explainer-title {
            font-weight: bold;
            color: var(--info);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Interactive Timeline */
        .execution-timeline {
            position: relative;
            margin: 40px 0;
            padding-left: 50px;
        }
        
        .timeline-step {
            position: relative;
            margin-bottom: 30px;
            opacity: 0.5;
            transition: opacity 0.3s;
        }
        
        .timeline-step.active { opacity: 1; }
        
        .timeline-step::before {
            content: '';
            position: absolute;
            left: -36px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary);
            border: 4px solid #fff;
            box-shadow: 0 0 0 2px var(--primary);
        }
        
        .timeline-step::after {
            content: '';
            position: absolute;
            left: -29px;
            top: 25px;
            width: 2px;
            height: calc(100% + 10px);
            background: #e2e8f0;
        }
        
        .timeline-step:last-child::after { display: none; }
        
        /* Badges */
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
        }
        .badge-ts { background: #3178c6; }
        .badge-tsx { background: #294e80; }
        
        /* Interactive Elements */
        .demo-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #5568d3; }
        
        .highlight-line {
            background: rgba(255, 255, 0, 0.1);
            display: block;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <h2>üîç Code Deep Dive</h2>
            <div class="nav-item active" onclick="showSection('architecture')">üèóÔ∏è System Architecture</div>
            <div class="nav-item" onclick="showSection('retry-logic')">üîÑ Exponential Backoff</div>
            <div class="nav-item" onclick="showSection('throttling')">üö¶ Adaptive Throttling</div>
            <div class="nav-item" onclick="showSection('integration')">üîå Integration Point</div>
            <div class="nav-item" onclick="showSection('execution')">‚ö° Execution Flow</div>
        </div>

        <!-- CONTENT -->
        <div class="content">
            
            <!-- ARCHITECTURE SECTION -->
            <div id="architecture" class="section active">
                <h1>üèóÔ∏è System Architecture</h1>
                <p>A high-level view of how the error recovery system intercepts and handles API calls.</p>
                
                <div class="flow-diagram">
                    <div class="flow-step">User Request</div>
                    <div class="arrow">‚¨áÔ∏è</div>
                    <div class="flow-step" style="border-color: var(--info)">Request Throttler</div>
                    <div class="arrow">‚¨áÔ∏è</div>
                    <div class="flow-step" style="border-color: var(--success)">API Call</div>
                    <div class="arrow">‚¨áÔ∏è</div>
                    <div class="flow-step" style="border-color: var(--warning)">Retry Manager</div>
                    <div class="arrow">‚¨áÔ∏è</div>
                    <div class="flow-step" style="border-color: var(--danger)">Error Recovery Engine</div>
                </div>

                <div class="explainer">
                    <div class="explainer-card">
                        <div class="explainer-title">üìÇ File Structure</div>
                        <ul>
                            <li><code>src/lib/retry-manager.ts</code> - The "Brain" (Retries)</li>
                            <li><code>src/lib/request-throttler.ts</code> - The "Traffic Cop" (Limits)</li>
                            <li><code>src/lib/error-recovery-engine.ts</code> - The "Coordinator"</li>
                            <li><code>src/OneMindAI.tsx</code> - The "Client" (Integration)</li>
                        </ul>
                    </div>
                    <div class="explainer-card">
                        <div class="explainer-title">üéØ Core Responsibilities</div>
                        <ul>
                            <li><strong>Throttler:</strong> Ensures we don't exceed 10 req/s</li>
                            <li><strong>Retry Manager:</strong> Handles backoff logic (1s, 2s, 4s)</li>
                            <li><strong>Recovery Engine:</strong> Decides IF we should retry</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- RETRY LOGIC SECTION -->
            <div id="retry-logic" class="section">
                <h1>üîÑ Exponential Backoff Logic</h1>
                <p>Deep dive into <code>src/lib/retry-manager.ts</code> where the math happens.</p>

                <div class="code-container">
                    <div class="file-header">
                        <div class="file-info">
                            <span class="file-icon">üìÑ</span>
                            <span>src/lib/retry-manager.ts</span>
                            <span class="badge badge-ts">TS</span>
                        </div>
                        <div class="line-info">Lines 35-46</div>
                    </div>
                    <pre><code class="typescript">  /**
   * Calculate delay with exponential backoff
   * Pattern: 1s ‚Üí 2s ‚Üí 4s ‚Üí 8s ‚Üí 16s (capped at maxDelay)
   */
  calculateDelay(attempt: number): number {
    // üí° THE FORMULA: baseDelay * (2 ^ attempt)
    const delay = Math.min(
      this.config.baseDelay * Math.pow(this.config.backoffMultiplier, attempt),
      this.config.maxDelay
    );
    
    // üé≤ JITTER: Adds randomness to prevent "thundering herd"
    const jitter = delay * 0.1 * Math.random();
    return Math.floor(delay + jitter);
  }</code></pre>
                </div>

                <div class="explainer">
                    <div class="explainer-card">
                        <div class="explainer-title">üßÆ The Math Explained</div>
                        <p>We use <code>Math.pow(2, attempt)</code> to double the delay each time:</p>
                        <ul>
                            <li><strong>Attempt 0:</strong> 1000 * 2^0 = 1000ms (1s)</li>
                            <li><strong>Attempt 1:</strong> 1000 * 2^1 = 2000ms (2s)</li>
                            <li><strong>Attempt 2:</strong> 1000 * 2^2 = 4000ms (4s)</li>
                            <li><strong>Attempt 3:</strong> 1000 * 2^3 = 8000ms (8s)</li>
                        </ul>
                    </div>
                    <div class="explainer-card">
                        <div class="explainer-title">üé≤ Why Jitter?</div>
                        <p>Notice the <code>jitter</code> calculation. We add random noise (¬±10%) to the delay.</p>
                        <p><strong>Why?</strong> If 1000 users fail at the exact same time, we don't want them all retrying at exactly 1.00 seconds later. Jitter spreads them out (1.05s, 0.95s, 1.1s).</p>
                    </div>
                </div>
            </div>

            <!-- THROTTLING SECTION -->
            <div id="throttling" class="section">
                <h1>üö¶ Adaptive Throttling</h1>
                <p>How <code>src/lib/request-throttler.ts</code> manages traffic flow.</p>

                <div class="code-container">
                    <div class="file-header">
                        <div class="file-info">
                            <span class="file-icon">üìÑ</span>
                            <span>src/lib/request-throttler.ts</span>
                            <span class="badge badge-ts">TS</span>
                        </div>
                        <div class="line-info">Lines 43-59</div>
                    </div>
                    <pre><code class="typescript">    // 1Ô∏è‚É£ Filter out requests older than 1 second
    this.requestTimestamps = this.requestTimestamps.filter(
      ts => now - ts < 1000
    );

    // 2Ô∏è‚É£ Check if we hit the limit (10 req/s)
    if (this.requestTimestamps.length >= this.config.maxRequestsPerSecond) {
      const oldestTimestamp = this.requestTimestamps[0];
      const waitTime = 1000 - (now - oldestTimestamp);
      
      // 3Ô∏è‚É£ WAIT if needed
      if (waitTime > 0) {
        console.log(`[Throttler] Rate limit reached. Waiting ${waitTime}ms...`);
        await this.sleep(waitTime);
      }
    }

    // 4Ô∏è‚É£ Record new request
    this.requestTimestamps.push(Date.now());</code></pre>
                </div>

                <h3>üêå Adaptive "Slow Down" Mode</h3>
                <p>When the server sends a 503 error, we enter "panic mode":</p>

                <div class="code-container">
                    <div class="file-header">
                        <div class="file-info">
                            <span class="file-icon">üìÑ</span>
                            <span>src/lib/request-throttler.ts</span>
                            <span class="badge badge-ts">TS</span>
                        </div>
                        <div class="line-info">Lines 68-75</div>
                    </div>
                    <pre><code class="typescript">  enterThrottleMode(durationMs: number = 15 * 60 * 1000) {
    this.isThrottled = true;
    this.throttleUntil = Date.now() + durationMs; // 15 minutes
    
    // üìâ Reduce rate to 30% (e.g., 10 -> 3 req/s)
    this.config.maxRequestsPerSecond = Math.max(1, Math.floor(this.originalRate * 0.3));
    
    console.log(`[Throttler] Entering throttle mode. New rate: ${this.config.maxRequestsPerSecond} req/s`);
  }</code></pre>
                </div>
            </div>

            <!-- INTEGRATION SECTION -->
            <div id="integration" class="section">
                <h1>üîå Integration Point</h1>
                <p>Where the magic happens in <code>src/OneMindAI.tsx</code>.</p>

                <div class="code-container">
                    <div class="file-header">
                        <div class="file-info">
                            <span class="file-icon">üìÑ</span>
                            <span>src/OneMindAI.tsx</span>
                            <span class="badge badge-tsx">TSX</span>
                        </div>
                        <div class="line-info">Lines 680-710</div>
                    </div>
                    <pre><code class="typescript">        let stream;
        try {
          // üõ°Ô∏è WRAPPER: autoFixRateLimit handles the retries
          stream = await autoFixRateLimit(
            'openai',
            makeOpenAIRequest, // üëà The original API call
            (status) => {
              // üì¢ Updates UI with "‚è≥ Rate limit retry 1/4..."
              logger.info(`[OpenAI Auto-Recovery] ${status}`);
              updateStreamingContent(e.id, `${status}\n\nPlease wait...`, true);
            }
          );
        } catch (firstError: any) {
          // üîÑ Fallback to Server Error Strategy
          if (firstError.statusCode === 500 || firstError.statusCode === 503) {
             stream = await autoFixServerError(/*...*/)
          } else {
             throw firstError; // ‚ùå Give up, show error panel
          }
        }</code></pre>
                </div>

                <div class="explainer">
                    <div class="explainer-card">
                        <div class="explainer-title">‚ú® How it works</div>
                        <ol>
                            <li>We define the API call as a function <code>makeOpenAIRequest</code></li>
                            <li>We pass it to <code>autoFixRateLimit</code></li>
                            <li>If it fails with 429, <code>autoFixRateLimit</code> waits and retries</li>
                            <li>If it succeeds, we get the <code>stream</code> back</li>
                            <li>If it fails with 500, we try <code>autoFixServerError</code></li>
                        </ol>
                    </div>
                </div>
            </div>

            <!-- EXECUTION FLOW SECTION -->
            <div id="execution" class="section">
                <h1>‚ö° Visual Execution Flow</h1>
                <p>Watch exactly what happens in the code when an error occurs.</p>

                <div class="demo-controls">
                    <button class="btn btn-primary" onclick="startExecutionDemo()">‚ñ∂Ô∏è Run Execution Simulation</button>
                </div>

                <div class="execution-timeline" id="timeline">
                    <!-- Steps inserted via JS -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>
        hljs.highlightAll();

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
        }

        function startExecutionDemo() {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';
            
            const steps = [
                {
                    title: "User Clicks Run",
                    desc: "Function <code>streamFromProvider</code> is called in <code>OneMindAI.tsx</code>",
                    file: "src/OneMindAI.tsx:650"
                },
                {
                    title: "Throttler Check",
                    desc: "<code>throttler.throttle()</code> checks request count. 10 req/s limit ok? ‚úÖ",
                    file: "src/lib/request-throttler.ts:45"
                },
                {
                    title: "API Request Sent",
                    desc: "<code>client.chat.completions.create()</code> initiates HTTP request",
                    file: "src/OneMindAI.tsx:670"
                },
                {
                    title: "‚ùå 429 Error Received",
                    desc: "OpenAI returns 'Rate limit reached'. Exception thrown.",
                    file: "src/lib/error-recovery-engine.ts:235"
                },
                {
                    title: "Retry Manager Activated",
                    desc: "<code>executeWithRetry</code> catches error. Checks if retryable.",
                    file: "src/lib/retry-manager.ts:60"
                },
                {
                    title: "‚è≥ Waiting...",
                    desc: "Calculating delay: 1000ms * 2^0 = 1000ms. Sleeping...",
                    file: "src/lib/retry-manager.ts:85"
                },
                {
                    title: "üîÑ Retry Attempt 1",
                    desc: "Calling <code>makeOpenAIRequest</code> again...",
                    file: "src/lib/retry-manager.ts:55"
                },
                {
                    title: "‚úÖ Success!",
                    desc: "Request succeeds. Stream returned to UI.",
                    file: "src/OneMindAI.tsx:710"
                }
            ];

            let i = 0;
            function nextStep() {
                if (i >= steps.length) return;
                
                const step = steps[i];
                const div = document.createElement('div');
                div.className = 'timeline-step';
                div.innerHTML = `
                    <h3>${step.title}</h3>
                    <p>${step.desc}</p>
                    <div style="font-family: monospace; font-size: 0.8rem; color: #666; margin-top: 5px;">
                        üìç ${step.file}
                    </div>
                `;
                timeline.appendChild(div);
                
                // Animate in
                setTimeout(() => div.classList.add('active'), 100);
                
                i++;
                if (i < steps.length) setTimeout(nextStep, 1500);
            }
            
            nextStep();
        }
    </script>
</body>
</html>
