# Phase 6: 7-Layer Data Flow Diagram with Cache & Fallback Orchestration

**Created:** 2025-12-15 | **Version:** 1.0

---

## Complete 7-Layer Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           LAYER 1: FRONTEND UI                              â”‚
â”‚                                                                             â”‚
â”‚  OneMindAI.tsx Component                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ User selects provider: "Anthropic"                                  â”‚   â”‚
â”‚  â”‚ User sets max_tokens: 1000                                          â”‚   â”‚
â”‚  â”‚ User clicks "Send Prompt"                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â†“                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LAYER 2: FRONTEND STATE & HOOKS                          â”‚
â”‚                                                                             â”‚
â”‚  useAdminConfig() Hook (src/hooks/useAdminConfig.ts)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. Check localStorage cache                                         â”‚   â”‚
â”‚  â”‚    â”œâ”€ Cache Key: 'onemindai-admin-config'                           â”‚   â”‚
â”‚  â”‚    â”œâ”€ TTL: 5 minutes                                                â”‚   â”‚
â”‚  â”‚    â””â”€ Status: âœ… VALID (cached 2 min ago)                           â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚ 2. Return cached providerConfig:                                    â”‚   â”‚
â”‚  â”‚    {                                                                â”‚   â”‚
â”‚  â”‚      provider: 'anthropic',                                         â”‚   â”‚
â”‚  â”‚      is_enabled: true,                                              â”‚   â”‚
â”‚  â”‚      max_output_cap: 8192,  â† Frontend knows this limit             â”‚   â”‚
â”‚  â”‚      rate_limit_rpm: 3500,                                          â”‚   â”‚
â”‚  â”‚      timeout_seconds: 30,                                           â”‚   â”‚
â”‚  â”‚      retry_count: 3                                                 â”‚   â”‚
â”‚  â”‚    }                                                                â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚ 3. Component receives: providerConfig                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â†“                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LAYER 3: FRONTEND SERVICES                               â”‚
â”‚                                                                             â”‚
â”‚  Business Logic (OneMindAI.tsx)                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ const maxTokenLimit = getProviderMaxOutput(                         â”‚   â”‚
â”‚  â”‚   providerConfig,                                                   â”‚   â”‚
â”‚  â”‚   'anthropic'                                                       â”‚   â”‚
â”‚  â”‚ );  // Returns: 8192                                                â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚ const finalMaxTokens = Math.min(1000, 8192);  // = 1000             â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚ Prepare request body:                                               â”‚   â”‚
â”‚  â”‚ {                                                                   â”‚   â”‚
â”‚  â”‚   messages: [...],                                                  â”‚   â”‚
â”‚  â”‚   model: 'claude-3-5-sonnet-20241022',                              â”‚   â”‚
â”‚  â”‚   max_tokens: 1000,  â† Enforced by frontend limit                   â”‚   â”‚
â”‚  â”‚   temperature: 0.7,                                                 â”‚   â”‚
â”‚  â”‚   stream: true                                                      â”‚   â”‚
â”‚  â”‚ }                                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â†“                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LAYER 4: BACKEND API ROUTES                              â”‚
â”‚                                                                             â”‚
â”‚  POST /api/anthropic (server/ai-proxy.cjs)                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Receives request:                                                   â”‚   â”‚
â”‚  â”‚ {                                                                   â”‚   â”‚
â”‚  â”‚   messages: [...],                                                  â”‚   â”‚
â”‚  â”‚   model: 'claude-3-5-sonnet-20241022',                              â”‚   â”‚
â”‚  â”‚   max_tokens: 1000,                                                 â”‚   â”‚
â”‚  â”‚   temperature: 0.7,                                                 â”‚   â”‚
â”‚  â”‚   stream: true                                                      â”‚   â”‚
â”‚  â”‚ }                                                                   â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚ Call getProviderLimit():                                            â”‚   â”‚
â”‚  â”‚ const maxTokenLimit = await getProviderLimit(                       â”‚   â”‚
â”‚  â”‚   'anthropic',                                                      â”‚   â”‚
â”‚  â”‚   'max_output_cap',                                                 â”‚   â”‚
â”‚  â”‚   8192  â† Fallback value (hardcoded)                                â”‚   â”‚
â”‚  â”‚ );                                                                  â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚ Enforce backend limit:                                              â”‚   â”‚
â”‚  â”‚ max_tokens: Math.min(1000, maxTokenLimit)                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â†“                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LAYER 5: BACKEND MIDDLEWARE                              â”‚
â”‚                                                                             â”‚
â”‚  getProviderLimit() Function (server/ai-proxy.cjs)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ STEP 1: Check In-Memory Cache                                       â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ â”‚ if (providerCache && Date.now() - cacheTime < 300000) {         â”‚ â”‚   â”‚
â”‚  â”‚ â”‚   return providerCache['anthropic']['max_output_cap'];          â”‚ â”‚   â”‚
â”‚  â”‚ â”‚   // Returns: 8192 (from cache, no DB query)                    â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ }                                                               â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ Cache Status: âœ… VALID (cached 2 min ago, expires in 3 min)     â”‚ â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚ STEP 2: Query Database (if cache expired)                          â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ â”‚ const { data } = await supabase                                 â”‚ â”‚   â”‚
â”‚  â”‚ â”‚   .from('provider_config')                                      â”‚ â”‚   â”‚
â”‚  â”‚ â”‚   .select('*');                                                 â”‚ â”‚   â”‚
â”‚  â”‚ â”‚                                                                 â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ providerCache = Object.fromEntries(                             â”‚ â”‚   â”‚
â”‚  â”‚ â”‚   data.map(r => [r.provider, r])                                â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ );                                                              â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ cacheTime = Date.now();                                         â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ return providerCache['anthropic']['max_output_cap'];            â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ // Returns: 8192 (from DB, now cached)                          â”‚ â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚ STEP 3: Return Fallback (if DB fails)                              â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ â”‚ } catch (err) {                                                 â”‚ â”‚   â”‚
â”‚  â”‚ â”‚   console.warn('DB error:', err.message);                       â”‚ â”‚   â”‚
â”‚  â”‚ â”‚   return fallback;  // Returns: 8192 (hardcoded)                â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ }                                                               â”‚ â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â†“                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          LAYER 6: DATABASE                                  â”‚
â”‚                                                                             â”‚
â”‚  Supabase PostgreSQL (provider_config table)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Query: SELECT * FROM provider_config WHERE provider = 'anthropic'   â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚ Result:                                                             â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ â”‚ provider â”‚ is_enabled â”‚ max_output   â”‚ rate_limit    â”‚ timeout â”‚ â”‚   â”‚
â”‚  â”‚ â”‚          â”‚            â”‚ _cap         â”‚ _rpm          â”‚ _secondsâ”‚ â”‚   â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚   â”‚
â”‚  â”‚ â”‚anthropic â”‚ true       â”‚ 8192         â”‚ 3500          â”‚ 30      â”‚ â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚ Status: âœ… AVAILABLE (Supabase is up)                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â†“                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      LAYER 7: EXTERNAL SERVICES                             â”‚
â”‚                                                                             â”‚
â”‚  Anthropic API (api.anthropic.com)                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Backend sends request:                                              â”‚   â”‚
â”‚  â”‚ POST https://api.anthropic.com/v1/messages                          â”‚   â”‚
â”‚  â”‚ {                                                                   â”‚   â”‚
â”‚  â”‚   model: 'claude-3-5-sonnet-20241022',                              â”‚   â”‚
â”‚  â”‚   messages: [...],                                                  â”‚   â”‚
â”‚  â”‚   max_tokens: 1000,  â† Enforced by BOTH frontend AND backend        â”‚   â”‚
â”‚  â”‚   temperature: 0.7,                                                 â”‚   â”‚
â”‚  â”‚   stream: true                                                      â”‚   â”‚
â”‚  â”‚ }                                                                   â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚ Anthropic API processes and returns streaming response              â”‚   â”‚
â”‚  â”‚ Backend forwards to frontend via SSE (Server-Sent Events)           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â†“                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              Response flows back
                              through all layers
```

---

## Cache & Fallback Orchestration Matrix

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CACHE ORCHESTRATION                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FRONTEND CACHE (Layer 2)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Storage: localStorage                                                        â”‚
â”‚ Key: 'onemindai-admin-config'                                                â”‚
â”‚ TTL: 5 minutes (300,000 ms)                                                  â”‚
â”‚ Size: ~2KB (all providers + system config)                                   â”‚
â”‚                                                                              â”‚
â”‚ Cache Hit Flow:                                                              â”‚
â”‚ useAdminConfig() â†’ getCachedConfig() â†’ localStorage.getItem()                â”‚
â”‚ â†’ Check timestamp â†’ Return cached data â†’ Component renders                   â”‚
â”‚                                                                              â”‚
â”‚ Cache Miss Flow:                                                             â”‚
â”‚ useAdminConfig() â†’ getCachedConfig() â†’ null â†’ Query Supabase                 â”‚
â”‚ â†’ Save to localStorage â†’ Return data â†’ Component renders                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

BACKEND CACHE (Layer 5)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Storage: In-memory variable (providerCache)                                  â”‚
â”‚ TTL: 5 minutes (300,000 ms)                                                  â”‚
â”‚ Size: ~1KB (all providers)                                                   â”‚
â”‚ Scope: Per Node.js process (lost on server restart)                          â”‚
â”‚                                                                              â”‚
â”‚ Cache Hit Flow:                                                              â”‚
â”‚ getProviderLimit() â†’ Check providerCache â†’ Check timestamp                   â”‚
â”‚ â†’ Return cached value â†’ Route continues                                      â”‚
â”‚                                                                              â”‚
â”‚ Cache Miss Flow:                                                             â”‚
â”‚ getProviderLimit() â†’ Check providerCache â†’ Expired/null                      â”‚
â”‚ â†’ Query Supabase â†’ Update providerCache â†’ Return value â†’ Route continues     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FALLBACK ORCHESTRATION                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FRONTEND FALLBACK (Layer 2)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Type: Array of hardcoded defaults                                            â”‚
â”‚ Location: DEFAULT_PROVIDER_CONFIG (useAdminConfig.ts, lines 67-77)           â”‚
â”‚                                                                              â”‚
â”‚ Fallback Trigger:                                                            â”‚
â”‚ 1. Supabase not configured (isSupabaseConfigured() = false)                  â”‚
â”‚ 2. Database query fails (error.message logged)                               â”‚
â”‚ 3. localStorage error (try/catch in getCachedConfig)                         â”‚
â”‚                                                                              â”‚
â”‚ Fallback Values:                                                             â”‚
â”‚ {                                                                            â”‚
â”‚   provider: 'anthropic',                                                     â”‚
â”‚   is_enabled: true,                                                          â”‚
â”‚   max_output_cap: 8192,  â† Used by component                                 â”‚
â”‚   rate_limit_rpm: 3500,                                                      â”‚
â”‚   timeout_seconds: 30,                                                       â”‚
â”‚   retry_count: 3                                                             â”‚
â”‚ }                                                                            â”‚
â”‚                                                                              â”‚
â”‚ Real-time Updates:                                                           â”‚
â”‚ - Supabase listeners auto-refresh on DB change                               â”‚
â”‚ - localStorage cache cleared immediately                                     â”‚
â”‚ - Component re-renders with new values                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

BACKEND FALLBACK (Layer 5)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Type: Hardcoded value in function call                                       â”‚
â”‚ Location: Each route (e.g., ai-proxy.cjs line ~881)                          â”‚
â”‚                                                                              â”‚
â”‚ Fallback Trigger:                                                            â”‚
â”‚ 1. Supabase not configured (supabase = null)                                 â”‚
â”‚ 2. Database query fails (catch block)                                        â”‚
â”‚ 3. Network error (fetch fails)                                               â”‚
â”‚                                                                              â”‚
â”‚ Fallback Values (per provider):                                              â”‚
â”‚ - openai: 16384                                                              â”‚
â”‚ - anthropic: 8192                                                            â”‚
â”‚ - gemini: 8192                                                               â”‚
â”‚ - mistral: 32768                                                             â”‚
â”‚ - perplexity: 4096                                                           â”‚
â”‚ - deepseek: 8192                                                             â”‚
â”‚ - groq: 8192                                                                 â”‚
â”‚ - xai: 16384                                                                 â”‚
â”‚ - kimi: 8192                                                                 â”‚
â”‚                                                                              â”‚
â”‚ Real-time Updates:                                                           â”‚
â”‚ - NO real-time updates (cache expires every 5 min)                           â”‚
â”‚ - Next request after expiry triggers DB query                                â”‚
â”‚ - New values cached and used                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Scenario: Admin Changes Anthropic Limit from 8192 â†’ 12000

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ADMIN ACTION: Update provider_config table                                  â”‚
â”‚ UPDATE provider_config SET max_output_cap = 12000 WHERE provider = 'anthropic'
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FRONTEND RESPONSE (Real-time via Supabase listeners)                        â”‚
â”‚                                                                             â”‚
â”‚ Time: T+0ms                                                                 â”‚
â”‚ Event: Supabase listener triggers (postgres_changes)                        â”‚
â”‚ Action: Clear localStorage cache                                            â”‚
â”‚ Action: Call fetchConfig() again                                            â”‚
â”‚                                                                             â”‚
â”‚ Time: T+50ms                                                                â”‚
â”‚ Event: New data fetched from Supabase                                       â”‚
â”‚ Data: max_output_cap = 12000                                                â”‚
â”‚ Action: Save to localStorage                                                â”‚
â”‚ Action: Component re-renders                                                â”‚
â”‚                                                                             â”‚
â”‚ Result: âœ… Frontend uses 12000 immediately                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND RESPONSE (Polling via cache expiry)                                 â”‚
â”‚                                                                             â”‚
â”‚ Time: T+0ms                                                                 â”‚
â”‚ Status: Backend cache still has 8192 (cached 2 min ago)                     â”‚
â”‚ Action: Continue using 8192 for requests                                    â”‚
â”‚                                                                             â”‚
â”‚ Time: T+3min                                                                â”‚
â”‚ Event: Cache expires (5 min TTL)                                            â”‚
â”‚ Action: Next request triggers getProviderLimit()                            â”‚
â”‚ Action: Query Supabase for new values                                       â”‚
â”‚                                                                             â”‚
â”‚ Time: T+3min+50ms                                                           â”‚
â”‚ Event: New data fetched from Supabase                                       â”‚
â”‚ Data: max_output_cap = 12000                                                â”‚
â”‚ Action: Update providerCache                                                â”‚
â”‚ Action: Use 12000 for this and future requests                              â”‚
â”‚                                                                             â”‚
â”‚ Result: â³ Backend uses 12000 after cache expires (max 5 min delay)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Failure Scenarios

### Scenario 1: Database is Down

```
FRONTEND:
  useAdminConfig() â†’ Query Supabase
  âŒ Error: Connection refused
  âœ… Fallback: Use DEFAULT_PROVIDER_CONFIG
  âœ… Component renders with hardcoded defaults
  âœ… User can still use app

BACKEND:
  getProviderLimit() â†’ Query Supabase
  âŒ Error: Connection refused
  âœ… Fallback: Return hardcoded value (8192)
  âœ… Route continues with fallback limit
  âœ… API request still works
```

### Scenario 2: Supabase Not Configured

```
FRONTEND:
  isSupabaseConfigured() = false
  âœ… Skip database query entirely
  âœ… Use DEFAULT_PROVIDER_CONFIG immediately
  âœ… Component renders instantly

BACKEND:
  supabase = null (no env vars)
  âœ… getProviderLimit() returns fallback (8192)
  âœ… Route continues with fallback limit
  âœ… API request works
```

### Scenario 3: Cache Valid

```
FRONTEND:
  localStorage has valid cache (< 5 min old)
  âœ… Return cached data immediately
  âŒ No database query
  âœ… Component renders instantly

BACKEND:
  providerCache has valid data (< 5 min old)
  âœ… Return cached value immediately
  âŒ No database query
  âœ… Route continues instantly
```

### Scenario 4: Cache Expired, Database Slow

```
FRONTEND:
  localStorage cache expired
  ğŸ”„ Query Supabase (takes 500ms)
  â³ Component shows loading state
  âœ… Data arrives, component renders

BACKEND:
  providerCache expired
  ğŸ”„ Query Supabase (takes 500ms)
  â³ Request waits for response
  âœ… Data arrives, route continues
```

---

## Summary Table

| Layer | Component | Cache Type | TTL | Fallback | Real-time |
|-------|-----------|-----------|-----|----------|-----------|
| **2** | useAdminConfig | localStorage | 5 min | DEFAULT array | âœ… Yes |
| **5** | getProviderLimit | In-memory | 5 min | Hardcoded | âŒ No |
| **6** | Database | N/A | N/A | N/A | N/A |

---

## Code Locations

| File | Purpose | Status |
|------|---------|--------|
| `src/hooks/useAdminConfig.ts` | Frontend cache + fallback | âœ… DONE |
| `src/OneMindAI.tsx` | Uses frontend config | âœ… DONE |
| `server/ai-proxy.cjs` | Backend cache + fallback | â³ TODO |
| `supabase/migrations/001_initial_schema.sql` | Database | âœ… DONE |

---

**End of 7-Layer Data Flow Diagram**
