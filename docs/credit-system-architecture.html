<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneMindAI - Credit System Architecture</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            padding: 40px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }

        header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            color: #666;
            font-size: 1.1em;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .section h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .section h3 {
            color: #764ba2;
            font-size: 1.5em;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        .flow-diagram {
            background: #f8f9fa;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
            position: relative;
        }

        .flow-step {
            background: white;
            border-left: 5px solid #667eea;
            padding: 20px;
            margin: 15px 0;
            border-radius: 5px;
            position: relative;
        }

        .flow-step.step-1 { border-left-color: #667eea; }
        .flow-step.step-2 { border-left-color: #764ba2; }
        .flow-step.step-3 { border-left-color: #f093fb; }
        .flow-step.step-4 { border-left-color: #4facfe; }
        .flow-step.step-5 { border-left-color: #00f2fe; }
        .flow-step.step-6 { border-left-color: #43e97b; }

        .flow-step::before {
            content: attr(data-step);
            position: absolute;
            left: -15px;
            top: 20px;
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
        }

        .flow-step.step-2::before { background: #764ba2; }
        .flow-step.step-3::before { background: #f093fb; }
        .flow-step.step-4::before { background: #4facfe; }
        .flow-step.step-5::before { background: #00f2fe; }
        .flow-step.step-6::before { background: #43e97b; }

        .flow-step h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .flow-step p {
            color: #555;
            margin: 8px 0;
        }

        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .code-block .keyword { color: #66d9ef; }
        .code-block .string { color: #e6db74; }
        .code-block .number { color: #ae81ff; }
        .code-block .function { color: #a6e22e; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }

        table tr:hover {
            background: #f5f5f5;
        }

        table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .highlight {
            background: #fff3cd;
            padding: 20px;
            border-left: 4px solid #ffc107;
            border-radius: 5px;
            margin: 20px 0;
        }

        .highlight strong {
            color: #856404;
        }

        .calculation-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }

        .calculation-box h4 {
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .calculation-box .formula {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.95em;
        }

        .model-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            display: inline-block;
            min-width: 300px;
            margin-right: 20px;
        }

        .model-card h4 {
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .model-card p {
            font-size: 0.9em;
            margin: 5px 0;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }

        .info-box strong {
            color: #0c5aa0;
        }

        .warning-box {
            background: #ffe7e7;
            border-left: 4px solid #f44336;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }

        .warning-box strong {
            color: #c62828;
        }

        .success-box {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }

        .success-box strong {
            color: #2e7d32;
        }

        .timeline {
            position: relative;
            padding: 20px 0;
        }

        .timeline-item {
            padding-left: 40px;
            padding-bottom: 30px;
            position: relative;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 20px;
            height: 20px;
            background: #667eea;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 0 3px #667eea;
        }

        .timeline-item::after {
            content: '';
            position: absolute;
            left: 8px;
            top: 20px;
            width: 4px;
            height: 30px;
            background: #ddd;
        }

        .timeline-item:last-child::after {
            display: none;
        }

        .timeline-item h4 {
            color: #667eea;
            margin-bottom: 5px;
        }

        .timeline-item p {
            color: #666;
            font-size: 0.95em;
        }

        .architecture-diagram {
            background: #f8f9fa;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
        }

        .box {
            display: inline-block;
            background: white;
            border: 2px solid #667eea;
            padding: 20px 30px;
            border-radius: 8px;
            margin: 10px;
            min-width: 150px;
            font-weight: 600;
            color: #667eea;
        }

        .arrow {
            display: inline-block;
            margin: 0 10px;
            color: #667eea;
            font-size: 1.5em;
        }

        .database-icon {
            display: inline-block;
            width: 40px;
            height: 40px;
            background: #667eea;
            color: white;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }

        footer {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            color: #666;
            margin-top: 30px;
        }

        .comparison-table {
            margin: 20px 0;
        }

        .comparison-table th {
            background: #667eea;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-right: 5px;
        }

        .badge-free {
            background: #4caf50;
            color: white;
        }

        .badge-budget {
            background: #2196F3;
            color: white;
        }

        .badge-standard {
            background: #9c27b0;
            color: white;
        }

        .badge-premium {
            background: #ff9800;
            color: white;
        }

        @media print {
            body {
                background: white;
            }
            .section {
                page-break-inside: avoid;
            }
        }

        .toc {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .toc h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .toc ul {
            list-style: none;
            padding-left: 0;
        }

        .toc li {
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }

        .toc li:last-child {
            border-bottom: none;
        }

        .toc a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.3s;
        }

        .toc a:hover {
            color: #764ba2;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>üí∞ OneMindAI Credit System Architecture</h1>
            <p>Complete Flow: $10 Purchase ‚Üí Credits ‚Üí Token Calculation ‚Üí Model Usage ‚Üí Credit Deduction</p>
        </header>

        <!-- Table of Contents -->
        <div class="section">
            <div class="toc">
                <h3>üìã Table of Contents</h3>
                <ul>
                    <li><a href="#overview">1. System Overview</a></li>
                    <li><a href="#purchase">2. $10 Purchase Flow</a></li>
                    <li><a href="#conversion">3. Credit Conversion</a></li>
                    <li><a href="#token-calc">4. Token Calculation</a></li>
                    <li><a href="#pricing">5. Model Pricing</a></li>
                    <li><a href="#deduction">6. Credit Deduction</a></li>
                    <li><a href="#database">7. Database Architecture</a></li>
                    <li><a href="#security">8. Security & Profit Markup</a></li>
                    <li><a href="#examples">9. Real-World Examples</a></li>
                </ul>
            </div>
        </div>

        <!-- 1. System Overview -->
        <div class="section" id="overview">
            <h2>1. üí° System Overview</h2>
            
            <h3>High-Level Architecture</h3>
            <div class="architecture-diagram">
                <div class="box">üíµ User Payment</div>
                <div class="arrow">‚Üí</div>
                <div class="box">üé´ Credits</div>
                <div class="arrow">‚Üí</div>
                <div class="box">ü§ñ API Call</div>
                <div class="arrow">‚Üí</div>
                <div class="box">üìä Token Count</div>
                <div class="arrow">‚Üí</div>
                <div class="box">üí∏ Deduction</div>
            </div>

            <h3>Key Components</h3>
            <table>
                <tr>
                    <th>Component</th>
                    <th>Purpose</th>
                    <th>Location</th>
                </tr>
                <tr>
                    <td><strong>Payment Gateway</strong></td>
                    <td>Processes $10 purchase</td>
                    <td>Stripe/PayPal Integration</td>
                </tr>
                <tr>
                    <td><strong>Credit System</strong></td>
                    <td>Converts USD to credits</td>
                    <td>Supabase Database</td>
                </tr>
                <tr>
                    <td><strong>Token Calculator</strong></td>
                    <td>Estimates input/output tokens</td>
                    <td>Frontend & Backend</td>
                </tr>
                <tr>
                    <td><strong>Pricing Engine</strong></td>
                    <td>Calculates credit cost per model</td>
                    <td>Backend (Secure)</td>
                </tr>
                <tr>
                    <td><strong>Deduction Service</strong></td>
                    <td>Atomically deducts credits</td>
                    <td>Supabase RPC Functions</td>
                </tr>
            </table>

            <div class="info-box">
                <strong>üí° Key Principle:</strong> Credits are deducted ONLY AFTER successful API response. Failed requests don't consume credits.
            </div>
        </div>

        <!-- 2. $10 Purchase Flow -->
        <div class="section" id="purchase">
            <h2>2. üí≥ $10 Purchase Flow</h2>

            <h3>Step-by-Step Process</h3>
            <div class="flow-diagram">
                <div class="flow-step step-1" data-step="1">
                    <h4>User Initiates Purchase</h4>
                    <p>User clicks "Buy Credits" button</p>
                    <p>Amount: <strong>$10 USD</strong></p>
                </div>

                <div class="flow-step step-2" data-step="2">
                    <h4>Payment Processing</h4>
                    <p>Stripe/PayPal processes payment</p>
                    <p>Webhook confirms successful payment</p>
                    <p>Transaction ID: <code>txn_1234567890</code></p>
                </div>

                <div class="flow-step step-3" data-step="3">
                    <h4>Credit Calculation</h4>
                    <p><strong>Formula:</strong> $10 √ó 100 credits/USD = 1,000 credits</p>
                    <p>Fixed rate: <strong>1 credit = $0.01</strong></p>
                </div>

                <div class="flow-step step-4" data-step="4">
                    <h4>Database Update</h4>
                    <p>Update <code>credits</code> table</p>
                    <p>Increment <code>balance</code> by 1,000</p>
                    <p>Increment <code>lifetime_earned</code> by 1,000</p>
                </div>

                <div class="flow-step step-5" data-step="5">
                    <h4>Transaction Logging</h4>
                    <p>Create entry in <code>credit_transactions</code> table</p>
                    <p>Type: <code>purchase</code></p>
                    <p>Amount: <code>+1,000</code></p>
                </div>

                <div class="flow-step step-6" data-step="6">
                    <h4>User Notification</h4>
                    <p>Display success message</p>
                    <p>Update balance in UI</p>
                    <p>Send confirmation email</p>
                </div>
            </div>

            <h3>Database Changes</h3>
            <div class="code-block">
<span class="keyword">BEFORE:</span>
  balance: 100
  lifetime_earned: 100
  lifetime_spent: 0

<span class="keyword">AFTER:</span>
  balance: 1100
  lifetime_earned: 1100
  lifetime_spent: 0
            </div>
        </div>

        <!-- 3. Credit Conversion -->
        <div class="section" id="conversion">
            <h2>3. üîÑ Credit Conversion</h2>

            <h3>Conversion Formula</h3>
            <div class="calculation-box">
                <h4>Credit Conversion</h4>
                <div class="formula">
                    1 Credit = $0.01 USD<br>
                    1,000 Credits = $10 USD<br>
                    100 Credits = $1 USD
                </div>
                <h4>$10 Purchase Breakdown</h4>
                <div class="formula">
                    $10 √ó (100 credits / $1) = 1,000 credits
                </div>
            </div>

            <h3>Credit Tiers</h3>
            <table>
                <tr>
                    <th>Purchase Amount</th>
                    <th>Credits Received</th>
                    <th>Cost per Credit</th>
                    <th>Bonus</th>
                </tr>
                <tr>
                    <td>$1</td>
                    <td>100 credits</td>
                    <td>$0.01</td>
                    <td>‚Äî</td>
                </tr>
                <tr>
                    <td>$5</td>
                    <td>500 credits</td>
                    <td>$0.01</td>
                    <td>‚Äî</td>
                </tr>
                <tr>
                    <td>$10</td>
                    <td>1,000 credits</td>
                    <td>$0.01</td>
                    <td>‚Äî</td>
                </tr>
                <tr>
                    <td>$50</td>
                    <td>5,500 credits</td>
                    <td>$0.0091</td>
                    <td>+500 (10%)</td>
                </tr>
                <tr>
                    <td>$100</td>
                    <td>12,000 credits</td>
                    <td>$0.0083</td>
                    <td>+2,000 (20%)</td>
                </tr>
            </table>

            <div class="success-box">
                <strong>‚úÖ Signup Bonus:</strong> All new users receive 100 free credits upon signup!
            </div>
        </div>

        <!-- 4. Token Calculation -->
        <div class="section" id="token-calc">
            <h2>4. üî¢ Token Calculation</h2>

            <h3>How Tokens Are Counted</h3>
            <div class="info-box">
                <strong>üìå Definition:</strong> Tokens are the smallest units of text that AI models process. Roughly 1 token ‚âà 4 characters or 1 word.
            </div>

            <h3>Token Estimation Process</h3>
            <div class="flow-diagram">
                <div class="flow-step step-1" data-step="1">
                    <h4>User Enters Prompt</h4>
                    <p>Example: "Explain quantum computing in simple terms"</p>
                    <p>Length: 50 characters</p>
                </div>

                <div class="flow-step step-2" data-step="2">
                    <h4>Frontend Estimates Input Tokens</h4>
                    <p>Formula: <code>characters / 4 = tokens</code></p>
                    <p>50 / 4 ‚âà 12 input tokens</p>
                </div>

                <div class="flow-step step-3" data-step="3">
                    <h4>Estimate Output Tokens</h4>
                    <p>Based on max output setting</p>
                    <p>Default: 1,000 output tokens</p>
                </div>

                <div class="flow-step step-4" data-step="4">
                    <h4>Calculate Estimated Cost</h4>
                    <p>Show user before API call</p>
                    <p>Example: "This will cost ~5 credits"</p>
                </div>

                <div class="flow-step step-5" data-step="5">
                    <h4>User Confirms</h4>
                    <p>User clicks "Send" button</p>
                    <p>API call is made</p>
                </div>

                <div class="flow-step step-6" data-step="6">
                    <h4>Get Actual Token Count</h4>
                    <p>API returns actual tokens used</p>
                    <p>Example: Input: 12, Output: 150</p>
                </div>
            </div>

            <h3>Token Counting Example</h3>
            <div class="calculation-box">
                <h4>Example: GPT-4o Query</h4>
                <div class="formula">
                    <strong>Input:</strong> "What is machine learning?"<br>
                    Characters: 26 ‚Üí Tokens: 26/4 ‚âà 7 tokens<br>
                    <br>
                    <strong>Output:</strong> ~500 words response<br>
                    Estimated: 500 words √ó 1.3 tokens/word ‚âà 650 tokens<br>
                    <br>
                    <strong>Total Tokens:</strong> 7 + 650 = 657 tokens
                </div>
            </div>

            <h3>Tokenizer by Provider</h3>
            <table>
                <tr>
                    <th>Provider</th>
                    <th>Model</th>
                    <th>Tokenizer</th>
                    <th>Avg Tokens/1K Words</th>
                </tr>
                <tr>
                    <td>OpenAI</td>
                    <td>GPT-4o</td>
                    <td>cl100k_base</td>
                    <td>~1,300</td>
                </tr>
                <tr>
                    <td>Anthropic</td>
                    <td>Claude 3.5</td>
                    <td>Claude Tokenizer</td>
                    <td>~1,350</td>
                </tr>
                <tr>
                    <td>Google</td>
                    <td>Gemini</td>
                    <td>SentencePiece</td>
                    <td>~1,200</td>
                </tr>
                <tr>
                    <td>DeepSeek</td>
                    <td>DeepSeek Chat</td>
                    <td>DeepSeek Tokenizer</td>
                    <td>~1,400</td>
                </tr>
            </table>

            <div class="warning-box">
                <strong>‚ö†Ô∏è Important:</strong> Token counts vary by provider. Always use the actual count from API response, not estimates.
            </div>
        </div>

        <!-- 5. Model Pricing -->
        <div class="section" id="pricing">
            <h2>5. üí∞ Model Pricing Structure</h2>

            <h3>Pricing Formula</h3>
            <div class="calculation-box">
                <h4>Credit Cost Calculation</h4>
                <div class="formula">
                    <strong>User Credit Cost = (Provider Cost √ó (1 + PROFIT_MARKUP)) √ó 100</strong><br>
                    <br>
                    Where:<br>
                    ‚Ä¢ Provider Cost = Cost per 1M tokens from provider<br>
                    ‚Ä¢ PROFIT_MARKUP = 30% (0.30)<br>
                    ‚Ä¢ 100 = Credits per USD<br>
                    <br>
                    <strong>Example (GPT-4o):</strong><br>
                    Input Cost: $2.50/1M tokens<br>
                    With Markup: $2.50 √ó 1.30 = $3.25/1M tokens<br>
                    In Credits: $3.25 √ó 100 = 325 credits/1M tokens
                </div>
            </div>

            <h3>Model Pricing Comparison</h3>
            <table>
                <tr>
                    <th>Model</th>
                    <th>Tier</th>
                    <th>Input Cost</th>
                    <th>Output Cost</th>
                    <th>Queries/$10</th>
                </tr>
                <tr>
                    <td>Gemini 2.0 Flash</td>
                    <td><span class="badge badge-free">FREE</span></td>
                    <td>$0/1M</td>
                    <td>$0/1M</td>
                    <td>‚àû Unlimited</td>
                </tr>
                <tr>
                    <td>Llama 3.1 8B</td>
                    <td><span class="badge badge-budget">Budget</span></td>
                    <td>0.05 cr/1M</td>
                    <td>0.08 cr/1M</td>
                    <td>~1,000,000</td>
                </tr>
                <tr>
                    <td>DeepSeek Chat</td>
                    <td><span class="badge badge-budget">Budget</span></td>
                    <td>1.4 cr/1M</td>
                    <td>2.8 cr/1M</td>
                    <td>~500,000</td>
                </tr>
                <tr>
                    <td>GPT-4o Mini</td>
                    <td><span class="badge badge-standard">Standard</span></td>
                    <td>15 cr/1M</td>
                    <td>60 cr/1M</td>
                    <td>~100,000</td>
                </tr>
                <tr>
                    <td>Claude 3 Haiku</td>
                    <td><span class="badge badge-standard">Standard</span></td>
                    <td>25 cr/1M</td>
                    <td>125 cr/1M</td>
                    <td>~50,000</td>
                </tr>
                <tr>
                    <td>GPT-4o</td>
                    <td><span class="badge badge-premium">Premium</span></td>
                    <td>325 cr/1M</td>
                    <td>1,300 cr/1M</td>
                    <td>~5,000</td>
                </tr>
                <tr>
                    <td>Claude 3.5 Sonnet</td>
                    <td><span class="badge badge-premium">Premium</span></td>
                    <td>390 cr/1M</td>
                    <td>1,950 cr/1M</td>
                    <td>~3,000</td>
                </tr>
            </table>

            <h3>$10 Distribution Across Models</h3>
            <p>With 1,000 credits from $10 purchase, here's how many queries you can make:</p>
            <table>
                <tr>
                    <th>Model</th>
                    <th>Avg Query Cost</th>
                    <th>Queries with $10</th>
                    <th>Total Output</th>
                </tr>
                <tr>
                    <td>Gemini Flash</td>
                    <td>0 credits</td>
                    <td>‚àû Unlimited</td>
                    <td>Unlimited</td>
                </tr>
                <tr>
                    <td>DeepSeek</td>
                    <td>~2 credits</td>
                    <td>~500 queries</td>
                    <td>~500,000 tokens</td>
                </tr>
                <tr>
                    <td>GPT-4o Mini</td>
                    <td>~10 credits</td>
                    <td>~100 queries</td>
                    <td>~100,000 tokens</td>
                </tr>
                <tr>
                    <td>GPT-4o</td>
                    <td>~100 credits</td>
                    <td>~10 queries</td>
                    <td>~10,000 tokens</td>
                </tr>
            </table>

            <div class="highlight">
                <strong>üí° Profit Markup Explanation:</strong> The 30% markup covers infrastructure costs, payment processing fees, support, and profit. This is calculated securely on the backend and never exposed to the frontend.
            </div>
        </div>

        <!-- 6. Credit Deduction -->
        <div class="section" id="deduction">
            <h2>6. üí∏ Credit Deduction Process</h2>

            <h3>Deduction Timeline</h3>
            <div class="timeline">
                <div class="timeline-item">
                    <h4>1. User Makes API Call</h4>
                    <p>User sends prompt to selected model</p>
                    <p>Frontend shows "Processing..." spinner</p>
                </div>

                <div class="timeline-item">
                    <h4>2. API Response Received</h4>
                    <p>Backend receives response from AI provider</p>
                    <p>Actual token count is known</p>
                </div>

                <div class="timeline-item">
                    <h4>3. Calculate Actual Cost</h4>
                    <p><strong>Provider Cost (USD):</strong></p>
                    <p>Input: 7 tokens √ó ($2.50/1M) = $0.0000175</p>
                    <p>Output: 650 tokens √ó ($10.00/1M) = $0.0065</p>
                    <p>Total Provider Cost: $0.0065175</p>
                    <p><br><strong>Convert to Credits:</strong></p>
                    <p>Input: 7 √ó (25/1M) = 0.000175 credits</p>
                    <p>Output: 650 √ó (100/1M) = 0.065 credits</p>
                    <p>Example: 657 tokens √ó (325 + 1300)/1M = ~1 credit</p>
                </div>

                <div class="timeline-item">
                    <h4>4. Check Sufficient Balance</h4>
                    <p>Verify user has enough credits</p>
                    <p>If insufficient: show error, don't deduct</p>
                </div>

                <div class="timeline-item">
                    <h4>5. Atomic Deduction</h4>
                    <p>Call Supabase RPC function: <code>deduct_credits()</code></p>
                    <p>Uses database transaction for atomicity</p>
                </div>

                <div class="timeline-item">
                    <h4>6. Log Transaction</h4>
                    <p>Create entry in <code>credit_transactions</code> table</p>
                    <p>Create entry in <code>api_usage</code> table</p>
                </div>

                <div class="timeline-item">
                    <h4>7. Update UI</h4>
                    <p>Show new balance to user</p>
                    <p>Display response from AI model</p>
                </div>
            </div>

            <h3>Deduction Code Flow</h3>
            <div class="code-block">
<span class="keyword">// Frontend: After successful API response</span>
<span class="keyword">const</span> deductResult = <span class="keyword">await</span> <span class="function">deductCredits</span>(
  userId,
  creditsToDeduct,
  provider,      <span class="string">// "openai"</span>
  model,         <span class="string">// "gpt-4o"</span>
  totalTokens,   <span class="number">// 657</span>
  description    <span class="string">// "API call to GPT-4o"</span>
);

<span class="keyword">if</span> (deductResult.success) {
  <span class="function">updateBalance</span>(deductResult.newBalance);
  <span class="function">showSuccess</span>(<span class="string">"Credits deducted successfully"</span>);
} <span class="keyword">else</span> {
  <span class="function">showError</span>(deductResult.error);
}
            </div>

            <h3>Deduction RPC Function (Backend)</h3>
            <div class="code-block">
<span class="keyword">CREATE OR REPLACE FUNCTION</span> public.<span class="function">deduct_credits</span>(
  p_user_id UUID,
  p_amount INTEGER,
  p_description TEXT,
  p_provider TEXT,
  p_model TEXT,
  p_tokens INTEGER
) <span class="keyword">RETURNS BOOLEAN AS</span> $$
<span class="keyword">DECLARE</span>
  v_current_balance INTEGER;
<span class="keyword">BEGIN</span>
  <span class="comment">-- Get current balance with row lock</span>
  <span class="keyword">SELECT</span> balance <span class="keyword">INTO</span> v_current_balance
  <span class="keyword">FROM</span> credits
  <span class="keyword">WHERE</span> user_id = p_user_id
  <span class="keyword">FOR UPDATE</span>;

  <span class="comment">-- Check sufficient balance</span>
  <span class="keyword">IF</span> v_current_balance IS NULL <span class="keyword">OR</span> 
     v_current_balance &lt; p_amount <span class="keyword">THEN</span>
    <span class="keyword">RETURN FALSE</span>;
  <span class="keyword">END IF</span>;

  <span class="comment">-- Deduct credits atomically</span>
  <span class="keyword">UPDATE</span> credits
  <span class="keyword">SET</span>
    balance = balance - p_amount,
    lifetime_spent = lifetime_spent + p_amount,
    updated_at = NOW()
  <span class="keyword">WHERE</span> user_id = p_user_id;

  <span class="comment">-- Log transaction</span>
  <span class="keyword">INSERT INTO</span> credit_transactions (
    user_id, amount, type, description, 
    provider, model, tokens
  ) <span class="keyword">VALUES</span> (
    p_user_id, -p_amount, <span class="string">'deduct'</span>, p_description,
    p_provider, p_model, p_tokens
  );

  <span class="keyword">RETURN TRUE</span>;
<span class="keyword">END</span>;
$$ <span class="keyword">LANGUAGE</span> plpgsql <span class="keyword">SECURITY DEFINER</span>;
            </div>

            <div class="success-box">
                <strong>‚úÖ Atomic Operation:</strong> The RPC function uses database transactions to ensure credits are only deducted if the operation succeeds completely. No partial deductions.
            </div>
        </div>

        <!-- 7. Database Architecture -->
        <div class="section" id="database">
            <h2>7. üóÑÔ∏è Database Architecture</h2>

            <h3>Core Tables</h3>

            <h4>1. Credits Table</h4>
            <div class="code-block">
<span class="keyword">CREATE TABLE</span> credits (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id),
  balance INTEGER DEFAULT 100,           <span class="comment">-- Current balance</span>
  lifetime_earned INTEGER DEFAULT 100,   <span class="comment">-- Total earned</span>
  lifetime_spent INTEGER DEFAULT 0,      <span class="comment">-- Total spent</span>
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id)
);
            </div>

            <h4>2. Credit Transactions Table</h4>
            <div class="code-block">
<span class="keyword">CREATE TABLE</span> credit_transactions (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id),
  amount INTEGER NOT NULL,               <span class="comment">-- Positive or negative</span>
  type TEXT NOT NULL,                    <span class="comment">-- 'purchase', 'deduct', 'refund', 'bonus'</span>
  description TEXT,
  provider TEXT,                         <span class="comment">-- 'openai', 'anthropic', etc.</span>
  model TEXT,                            <span class="comment">-- 'gpt-4o', 'claude-3.5', etc.</span>
  tokens INTEGER,                        <span class="comment">-- Total tokens used</span>
  created_at TIMESTAMP DEFAULT NOW()
);
            </div>

            <h4>3. API Usage Table</h4>
            <div class="code-block">
<span class="keyword">CREATE TABLE</span> api_usage (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id),
  provider TEXT NOT NULL,                <span class="comment">-- 'openai', 'anthropic', etc.</span>
  model TEXT NOT NULL,                   <span class="comment">-- 'gpt-4o', 'claude-3.5', etc.</span>
  input_tokens INTEGER NOT NULL,
  output_tokens INTEGER NOT NULL,
  total_tokens INTEGER NOT NULL,
  credits_used INTEGER NOT NULL,
  prompt TEXT,                           <span class="comment">-- Stored for analytics</span>
  response_length INTEGER,
  status TEXT,                           <span class="comment">-- 'success', 'failed'</span>
  error_message TEXT,
  response_time_ms INTEGER,
  created_at TIMESTAMP DEFAULT NOW()
);
            </div>

            <h3>Data Flow Diagram</h3>
            <div class="architecture-diagram">
                <div style="margin: 20px 0;">
                    <div style="background: white; border: 2px solid #667eea; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <strong>User Makes API Call</strong>
                    </div>
                    <div style="text-align: center; color: #667eea; font-size: 1.5em;">‚Üì</div>
                    <div style="background: white; border: 2px solid #667eea; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <strong>API Response Received</strong>
                    </div>
                    <div style="text-align: center; color: #667eea; font-size: 1.5em;">‚Üì</div>
                    <div style="background: white; border: 2px solid #667eea; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <strong>Calculate Credits to Deduct</strong>
                    </div>
                    <div style="text-align: center; color: #667eea; font-size: 1.5em;">‚Üì</div>
                    <div style="background: white; border: 2px solid #667eea; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <strong>Call deduct_credits() RPC</strong>
                    </div>
                    <div style="text-align: center; color: #667eea; font-size: 1.5em;">‚Üì</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <div style="background: white; border: 2px solid #667eea; padding: 15px; border-radius: 8px;">
                            <strong>Update credits table</strong>
                        </div>
                        <div style="background: white; border: 2px solid #667eea; padding: 15px; border-radius: 8px;">
                            <strong>Insert into credit_transactions</strong>
                        </div>
                        <div style="background: white; border: 2px solid #667eea; padding: 15px; border-radius: 8px;">
                            <strong>Insert into api_usage</strong>
                        </div>
                    </div>
                </div>
            </div>

            <h3>Row Level Security (RLS) Policies</h3>
            <div class="code-block">
<span class="comment">-- Users can only view their own credits</span>
<span class="keyword">CREATE POLICY</span> <span class="string">"Users can view own credits"</span>
  <span class="keyword">ON</span> credits
  <span class="keyword">FOR SELECT</span>
  <span class="keyword">USING</span> (auth.uid() = user_id);

<span class="comment">-- Users can only view their own transactions</span>
<span class="keyword">CREATE POLICY</span> <span class="string">"Users can view own transactions"</span>
  <span class="keyword">ON</span> credit_transactions
  <span class="keyword">FOR SELECT</span>
  <span class="keyword">USING</span> (auth.uid() = user_id);

<span class="comment">-- Only RPC function can insert transactions</span>
<span class="keyword">CREATE POLICY</span> <span class="string">"Only RPC can insert transactions"</span>
  <span class="keyword">ON</span> credit_transactions
  <span class="keyword">FOR INSERT</span>
  <span class="keyword">WITH CHECK</span> (<span class="keyword">true</span>);
            </div>
        </div>

        <!-- 8. Security & Profit Markup -->
        <div class="section" id="security">
            <h2>8. üîí Security & Profit Markup</h2>

            <h3>Profit Markup Strategy</h3>
            <div class="calculation-box">
                <h4>Markup Calculation</h4>
                <div class="formula">
                    <strong>PROFIT_MARKUP = 30%</strong><br>
                    <br>
                    User Credit Cost = Provider Cost √ó 1.30 √ó 100<br>
                    <br>
                    <strong>Example:</strong><br>
                    Provider charges: $2.50/1M tokens<br>
                    Your cost: $2.50 √ó 1.30 = $3.25/1M tokens<br>
                    Your profit: $0.75/1M tokens (30%)
                </div>
            </div>

            <h3>Markup Breakdown</h3>
            <table>
                <tr>
                    <th>Cost Component</th>
                    <th>Percentage</th>
                    <th>Purpose</th>
                </tr>
                <tr>
                    <td>Provider Cost</td>
                    <td>100%</td>
                    <td>Actual API costs</td>
                </tr>
                <tr>
                    <td>Infrastructure</td>
                    <td>10%</td>
                    <td>Servers, bandwidth, storage</td>
                </tr>
                <tr>
                    <td>Payment Processing</td>
                    <td>5%</td>
                    <td>Stripe/PayPal fees</td>
                </tr>
                <tr>
                    <td>Support & Operations</td>
                    <td>8%</td>
                    <td>Customer support, monitoring</td>
                </tr>
                <tr>
                    <td>Profit</td>
                    <td>7%</td>
                    <td>Business profit</td>
                </tr>
            </table>

            <h3>Security Best Practices</h3>

            <div class="info-box">
                <strong>üîê Frontend:</strong> Never expose actual provider costs or profit markup. Only show credit prices to users.
            </div>

            <div class="code-block">
<span class="comment">// ‚ùå WRONG - Exposes provider costs</span>
<span class="keyword">const</span> providerCost = <span class="number">2.50</span>;
<span class="keyword">const</span> userPrice = providerCost * <span class="number">1.30</span>;
<span class="function">displayPrice</span>(userPrice);

<span class="comment">// ‚úÖ CORRECT - Only show credits</span>
<span class="keyword">const</span> creditCost = <span class="number">325</span>;  <span class="comment">// Pre-calculated on backend</span>
<span class="function">displayPrice</span>(creditCost + <span class="string">" credits"</span>);
            </div>

            <div class="warning-box">
                <strong>‚ö†Ô∏è Backend Only:</strong> All pricing calculations must happen on the backend. Frontend receives only the final credit cost.
            </div>

            <h3>Secure Pricing Configuration</h3>
            <div class="code-block">
<span class="comment">// server/.env - NEVER expose to frontend</span>
PROFIT_MARKUP=0.30
PROVIDER_COSTS_OPENAI_GPT4O_INPUT=2.50
PROVIDER_COSTS_OPENAI_GPT4O_OUTPUT=10.00
PROVIDER_COSTS_ANTHROPIC_CLAUDE_INPUT=3.00
PROVIDER_COSTS_ANTHROPIC_CLAUDE_OUTPUT=15.00

<span class="comment">// Frontend only gets:</span>
<span class="comment">// "This will cost 325 credits"</span>
            </div>

            <h3>Audit Trail</h3>
            <p>Every credit transaction is logged for security and compliance:</p>
            <table>
                <tr>
                    <th>Field</th>
                    <th>Purpose</th>
                </tr>
                <tr>
                    <td>user_id</td>
                    <td>Who made the transaction</td>
                </tr>
                <tr>
                    <td>amount</td>
                    <td>How many credits</td>
                </tr>
                <tr>
                    <td>type</td>
                    <td>Transaction type (purchase/deduct/refund)</td>
                </tr>
                <tr>
                    <td>provider</td>
                    <td>Which AI provider was used</td>
                </tr>
                <tr>
                    <td>model</td>
                    <td>Which model was used</td>
                </tr>
                <tr>
                    <td>tokens</td>
                    <td>Total tokens consumed</td>
                </tr>
                <tr>
                    <td>created_at</td>
                    <td>Timestamp of transaction</td>
                </tr>
            </table>
        </div>

        <!-- 9. Real-World Examples -->
        <div class="section" id="examples">
            <h2>9. üìä Real-World Examples</h2>

            <h3>Example 1: GPT-4o Query</h3>
            <div class="flow-diagram">
                <div class="flow-step step-1" data-step="1">
                    <h4>User Input</h4>
                    <p><strong>Prompt:</strong> "Explain machine learning"</p>
                    <p><strong>Model:</strong> GPT-4o</p>
                    <p><strong>Max Output:</strong> 1,000 tokens</p>
                </div>

                <div class="flow-step step-2" data-step="2">
                    <h4>Token Estimation</h4>
                    <p>Input: "Explain machine learning" = 4 tokens</p>
                    <p>Output: ~1,000 tokens (user setting)</p>
                    <p>Estimated cost: ~100 credits</p>
                </div>

                <div class="flow-step step-3" data-step="3">
                    <h4>API Call</h4>
                    <p>Send to OpenAI API</p>
                    <p>Receive response</p>
                </div>

                <div class="flow-step step-4" data-step="4">
                    <h4>Actual Tokens</h4>
                    <p>Input: 4 tokens</p>
                    <p>Output: 287 tokens (actual)</p>
                    <p>Total: 291 tokens</p>
                </div>

                <div class="flow-step step-5" data-step="5">
                    <h4>Calculate Cost</h4>
                    <p>Input cost: 4 √ó (325/1M) = 0.0013 credits</p>
                    <p>Output cost: 287 √ó (1300/1M) = 0.373 credits</p>
                    <p>Total: 0.374 credits ‚âà 1 credit (rounded up)</p>
                </div>

                <div class="flow-step step-6" data-step="6">
                    <h4>Deduct Credits</h4>
                    <p>User balance: 1,000 - 1 = 999 credits</p>
                    <p>Log transaction</p>
                    <p>Show response to user</p>
                </div>
            </div>

            <h3>Example 2: Multiple Queries with $10</h3>
            <table>
                <tr>
                    <th>Query #</th>
                    <th>Model</th>
                    <th>Input Tokens</th>
                    <th>Output Tokens</th>
                    <th>Credits Used</th>
                    <th>Balance After</th>
                </tr>
                <tr>
                    <td>1</td>
                    <td>GPT-4o Mini</td>
                    <td>50</td>
                    <td>500</td>
                    <td>8</td>
                    <td>992</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>DeepSeek</td>
                    <td>100</td>
                    <td>800</td>
                    <td>2</td>
                    <td>990</td>
                </tr>
                <tr>
                    <td>3</td>
                    <td>Claude 3 Haiku</td>
                    <td>75</td>
                    <td>600</td>
                    <td>9</td>
                    <td>981</td>
                </tr>
                <tr>
                    <td>4</td>
                    <td>Gemini Flash</td>
                    <td>200</td>
                    <td>1000</td>
                    <td>0</td>
                    <td>981</td>
                </tr>
                <tr>
                    <td>5</td>
                    <td>GPT-4o</td>
                    <td>30</td>
                    <td>250</td>
                    <td>33</td>
                    <td>948</td>
                </tr>
            </table>

            <div class="highlight">
                <strong>üí° Insight:</strong> With $10 (1,000 credits), you can make 5 diverse queries across different models, with Gemini being completely free!
            </div>

            <h3>Example 3: Failed Request (No Deduction)</h3>
            <div class="flow-diagram">
                <div class="flow-step step-1" data-step="1">
                    <h4>User Makes Query</h4>
                    <p>Model: GPT-4o</p>
                    <p>Estimated cost: 50 credits</p>
                </div>

                <div class="flow-step step-2" data-step="2">
                    <h4>API Error</h4>
                    <p>OpenAI returns error: "Rate limit exceeded"</p>
                    <p>HTTP Status: 429</p>
                </div>

                <div class="flow-step step-3" data-step="3">
                    <h4>No Deduction</h4>
                    <p>Credits NOT deducted (request failed)</p>
                    <p>Balance remains: 1,000 credits</p>
                </div>

                <div class="flow-step step-4" data-step="4">
                    <h4>Show Error to User</h4>
                    <p>Display: "API rate limit exceeded. Please try again later."</p>
                    <p>No credits were charged</p>
                </div>

                <div class="flow-step step-5" data-step="5">
                    <h4>Log Error</h4>
                    <p>Create entry in api_usage table</p>
                    <p>status: 'failed'</p>
                    <p>error_message: 'Rate limit exceeded'</p>
                </div>

                <div class="flow-step step-6" data-step="6">
                    <h4>User Can Retry</h4>
                    <p>User can retry the same query</p>
                    <p>Still has full 1,000 credits</p>
                </div>
            </div>

            <h3>Example 4: 657 Tokens Conversion (Detailed Breakdown)</h3>
            <div class="calculation-box">
                <h4>Scenario: GPT-4o Query with 657 Total Tokens</h4>
                <div class="formula">
                    <strong>Token Breakdown:</strong><br>
                    Input: "What is machine learning?" = 7 tokens<br>
                    Output: ~500 words response = 650 tokens<br>
                    Total: 657 tokens<br>
                    <br>
                    <strong>Step 1: Provider Cost (USD)</strong><br>
                    Input: 7 tokens √ó ($2.50/1M tokens) = $0.0000175<br>
                    Output: 650 tokens √ó ($10.00/1M tokens) = $0.0065<br>
                    Total Provider Cost: $0.0065175<br>
                    <br>
                    <strong>Step 2: Convert to Credits</strong><br>
                    Input: 7 √ó (25 credits/1M) = 0.000175 credits<br>
                    Output: 650 √ó (100 credits/1M) = 0.065 credits<br>
                    Total: 0.065175 credits ‚âà 1 credit (rounded up)<br>
                    <br>
                    <strong>Result:</strong><br>
                    User Balance: 1,000 - 1 = 999 credits<br>
                    Provider Cost: $0.0065<br>
                    User Charged: 1 credit ($0.01)<br>
                    Profit Margin: $0.0035 (30% markup)
                </div>
            </div>

            <h3>Example 5: Large Query (Premium Model)</h3>
            <div class="calculation-box">
                <h4>Scenario: Long Research Paper Analysis</h4>
                <div class="formula">
                    <strong>Input:</strong> 50,000 character research paper<br>
                    Tokens: 50,000 / 4 ‚âà 12,500 tokens<br>
                    <br>
                    <strong>Model:</strong> GPT-4o (Premium)<br>
                    <br>
                    <strong>Calculation:</strong><br>
                    Input cost: 12,500 √ó (325/1M) = 4.06 credits<br>
                    Output cost: 2,000 √ó (1300/1M) = 2.60 credits<br>
                    Total: 6.66 credits ‚âà 7 credits<br>
                    <br>
                    <strong>Result:</strong><br>
                    Balance: 1,000 - 7 = 993 credits<br>
                    Queries remaining: ~142 similar queries
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer>
            <p>üìö OneMindAI Credit System Architecture</p>
            <p>Last Updated: December 2024</p>
            <p>For questions or issues, contact: support@onemindai.com</p>
        </footer>
    </div>
</body>
</html>
